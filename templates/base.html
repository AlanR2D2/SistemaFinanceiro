<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}Sistema Financeiro{% endblock %}</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body { font-family: 'Inter', sans-serif; }
    .min-h-screen { display:flex; }

    #sidebar{
      width: 18.5rem;
      transition: width 200ms ease-in-out;
      flex-shrink: 0;
    }
    #sidebar.sidebar-collapsed{ width: 6.5rem; }

    #mainContent{
      flex: 1;
      display:flex;
      flex-direction:column;
      min-width:0;
    }

    .sidebar-logo{
      width:2.5rem; height:2.5rem;
      flex-shrink:0; object-fit:cover;
    }

    /* ===== NAV ===== */
    .nav-link{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 12px;
      border-radius: 14px;
      color:#374151;
      transition: background .15s ease, color .15s ease, transform .06s ease;
    }
    .nav-link:hover{ background:#f3f4f6; color:#111827; }
    .nav-link:active{ transform: translateY(1px); }

    .nav-active{
      background:#eef2ff;
      color:#111827;
      border:1px solid #c7d2fe;
    }

    /* ===== Segments ===== */
    .seg{
      margin-top: 14px;
      padding-top: 14px;
      position: relative;
    }
    .seg::before{
      content:"";
      position:absolute;
      top:0; left:0; right:0;
      height:1px;
      background: linear-gradient(
        90deg,
        rgba(229,231,235,0) 0%,
        rgba(229,231,235,1) 18%,
        rgba(229,231,235,1) 82%,
        rgba(229,231,235,0) 100%
      );
    }
    .seg-title{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 6px 10px 10px 10px;
      color:#6b7280;
      font-size:11px;
      font-weight:800;
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .seg-dot{
      width:7px; height:7px;
      border-radius:999px;
      background:#e5e7eb;
      flex:0 0 auto;
    }

    /* ===== Section header row ===== */
    .sec-head{
      display:flex;
      align-items:center;
      gap:12px;
      padding: 10px 12px;
      border-radius: 14px;
      background:#f9fafb;
      border:1px solid #eef2f7;
    }
    .sec-head .label{
      font-weight:900;
      color:#111827;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* ===== Tabs ===== */
    .tab-group{
      margin-top: 8px;
      padding-left: 3.1rem;
      position: relative;
    }
    .tab-group::before{
      content:"";
      position:absolute;
      left: 1.55rem;
      top: 4px;
      bottom: 4px;
      width:1px;
      background:#eef2f7;
    }
    .tab-link{
      display:flex;
      align-items:center;
      gap:10px;
      padding: 9px 12px;
      border-radius: 12px;
      color:#374151;
      margin-top:6px;
      transition: background .15s ease, color .15s ease, border .15s ease;
      border:1px solid transparent;
    }
    .tab-link:hover{ background:#f3f4f6; color:#111827; }
    .tab-active{
      background:#eef2ff;
      border-color:#c7d2fe;
      color:#111827;
    }

    /* ===== Collapsed ===== */
    .sidebar-collapsed .sidebar-text,
    .sidebar-collapsed .sidebar-user,
    .sidebar-collapsed .seg-title,
    .sidebar-collapsed .tab-group{
      display:none !important;
    }
    .sidebar-collapsed nav{ padding-left: 10px !important; padding-right: 10px !important; }

    /* ícones alinhados em coluna */
    .sidebar-collapsed .nav-link,
    .sidebar-collapsed .sec-head{
      justify-content:center !important;
      gap:0 !important;
      padding-left:0 !important;
      padding-right:0 !important;
      height:44px;
      width:44px;
      margin-left:auto;
      margin-right:auto;
      border-radius:14px;
    }
    .sidebar-collapsed .nav-link i,
    .sidebar-collapsed .sec-head i{
      margin-right:0 !important;
    }
    .sidebar-collapsed .seg{ margin-top: 10px; padding-top: 10px; }
    .sidebar-collapsed .seg::before{ left: 10px; right: 10px; }
  </style>
</head>

<body class="bg-gray-50">
  <div class="min-h-screen flex">

    <div id="sidebarOverlay"
         class="fixed inset-0 bg-black/40 z-40 hidden md:hidden"
         aria-hidden="true"></div>

    <aside id="sidebar"
           class="fixed md:static inset-y-0 left-0 z-50 md:z-auto
                  bg-white border-r border-gray-200
                  hidden md:flex md:flex-col
                  transition-all duration-200 ease-in-out">

      <div class="p-6 border-b">
        <div class="flex items-center gap-3">
          <img src="{{ url_for('static', filename='images/logo.png') }}"
               class="w-10 h-10 rounded-full object-cover sidebar-logo" alt="Logo">

          <div class="sidebar-user sidebar-text">
            <div class="font-bold text-gray-800 leading-tight">Sistema Financeiro</div>
            <div class="text-xs text-gray-500">{{ current_user.nome or current_user.login }}</div>
            <div class="text-xs text-gray-500">Hierarquia: {{ current_user.hierarquia }}</div>
          </div>

          <button id="collapseBtn"
                  type="button"
                  class="ml-auto hidden md:inline-flex items-center justify-center
                         w-9 h-9 rounded-lg hover:bg-gray-100 text-gray-600"
                  aria-label="Recolher menu">
            <i id="collapseIcon" data-feather="chevrons-left" class="w-5 h-5"></i>
          </button>
        </div>
      </div>

      <nav class="p-4 space-y-2">
        <a href="/" class="nav-link" data-path="/">
          <i data-feather="home" class="w-5 h-5"></i>
          <span class="sidebar-text">Dashboard</span>
        </a>

        <!-- ACORDOS -->
        <div class="seg">
          <div class="seg-title">
            <span class="seg-dot"></span>
            <span class="sidebar-text">Acordos</span>
          </div>

          <div class="sec-head">
            <i data-feather="file-text" class="w-5 h-5"></i>
            <span class="sidebar-text label">Acordos</span>
          </div>

          <div class="tab-group">
            <a href="/acordos/ativos" class="tab-link" data-path="/acordos/ativos">
              <i data-feather="activity" class="w-5 h-5"></i>
              <span class="sidebar-text font-semibold">Ativos</span>
            </a>

            <a href="/acordos/finalizados" class="tab-link" data-path="/acordos/finalizados">
              <i data-feather="check-circle" class="w-5 h-5"></i>
              <span class="sidebar-text font-semibold">Finalizados</span>
            </a>
          </div>
        </div>

        <!-- MANDADOS -->
        <div class="seg">
          <div class="seg-title">
            <span class="seg-dot"></span>
            <span class="sidebar-text">Mandados</span>
          </div>

          <div class="sec-head">
            <i data-feather="layers" class="w-5 h-5"></i>
            <span class="sidebar-text label">Mandados</span>
          </div>

          <div class="tab-group">
            <a href="/mandados/ativos" class="tab-link" data-path="/mandados/ativos">
              <i data-feather="activity" class="w-5 h-5"></i>
              <span class="sidebar-text font-semibold">Ativos</span>
            </a>

            <a href="/mandados/finalizados" class="tab-link" data-path="/mandados/finalizados">
              <i data-feather="check-circle" class="w-5 h-5"></i>
              <span class="sidebar-text font-semibold">Finalizados</span>
            </a>
          </div>
        </div>

        {% if (current_user.hierarquia or "")|lower in ["admin", "administrador", "master"] %}
          <div class="seg">
            <div class="seg-title">
              <span class="seg-dot"></span>
              <span class="sidebar-text">Admin</span>
            </div>

            <a href="{{ url_for('cadastros') }}" class="nav-link" data-path="/cadastros">
              <i data-feather="settings" class="w-5 h-5"></i>
              <span class="sidebar-text">Cadastros</span>
            </a>

            <a href="{{ url_for('users_admin') }}" class="nav-link" data-path="/usuarios">
              <i data-feather="users" class="w-5 h-5"></i>
              <span class="sidebar-text">Usuários</span>
            </a>
          </div>
        {% endif %}

        <!-- CONFIGURAÇÕES (TODOS) -->
        <div class="seg">
          <div class="seg-title">
            <span class="seg-dot"></span>
            <span class="sidebar-text">Conta</span>
          </div>

          <a href="{{ url_for('config_page') }}" class="nav-link" data-path="/config">
            <i data-feather="user" class="w-5 h-5"></i>
            <span class="sidebar-text">Configurações</span>
          </a>
        </div>
      </nav>

      <div class="mt-auto p-4 border-t">
        <a href="/logout" class="nav-link">
          <i data-feather="log-out" class="w-5 h-5"></i>
          <span class="sidebar-text">Sair</span>
        </a>
      </div>
    </aside>

    <main id="mainContent" class="flex-1">
      <div class="bg-white border-b border-gray-200">
        <div class="px-6 py-4 flex items-center justify-between gap-3">
          <div class="flex items-center gap-3">
            <button id="mobileMenuBtn"
                    type="button"
                    class="inline-flex md:hidden items-center justify-center
                           w-10 h-10 rounded-lg hover:bg-gray-100 text-gray-700"
                    aria-label="Abrir menu">
              <i data-feather="menu" class="w-5 h-5"></i>
            </button>

            <div class="font-semibold text-gray-800">{% block header %}{% endblock %}</div>
          </div>

          <div class="flex items-center gap-3">
            <div class="text-sm text-gray-500 hidden sm:block">{{ current_user.email }}</div>

            <!-- Atalho Config (todos) -->
            <a href="{{ url_for('config_page') }}"
               class="hidden sm:inline-flex items-center justify-center w-10 h-10 rounded-lg hover:bg-gray-100 text-gray-700"
               title="Configurações">
              <i data-feather="settings" class="w-5 h-5"></i>
            </a>
          </div>
        </div>
      </div>

      <div class="p-6">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <script>
    feather.replace();

    const sidebar = document.getElementById("sidebar");
    const collapseBtn = document.getElementById("collapseBtn");
    const collapseIcon = document.getElementById("collapseIcon");

    const mobileMenuBtn = document.getElementById("mobileMenuBtn");
    const overlay = document.getElementById("sidebarOverlay");

    // highlight active tab
    (function(){
      const path = (window.location.pathname || "/").replace(/\/+$/,'') || "/";
      const links = Array.from(document.querySelectorAll('a[data-path]'));
      let best = null, bestLen = -1;

      links.forEach(a=>{
        const p = (a.getAttribute('data-path')||"").replace(/\/+$/,'') || "/";
        if (p === "/" && path !== "/") return;
        if (path === p || (p !== "/" && path.startsWith(p))) {
          if (p.length > bestLen) { best = a; bestLen = p.length; }
        }
      });

      if (best) {
        if (best.classList.contains('tab-link')) best.classList.add('tab-active');
        else best.classList.add('nav-active');
      }
    })();

    function setCollapsed(collapsed) {
      if (collapsed) {
        sidebar.classList.add("sidebar-collapsed");
        collapseIcon.setAttribute("data-feather", "chevrons-right");
        collapseBtn.setAttribute("aria-label", "Expandir menu");
      } else {
        sidebar.classList.remove("sidebar-collapsed");
        collapseIcon.setAttribute("data-feather", "chevrons-left");
        collapseBtn.setAttribute("aria-label", "Recolher menu");
      }
      feather.replace();
      localStorage.setItem("sidebarCollapsed", collapsed ? "1" : "0");
    }

    const saved = localStorage.getItem("sidebarCollapsed");
    if (saved === "1") setCollapsed(true);

    collapseBtn?.addEventListener("click", () => {
      const isCollapsed = sidebar.classList.contains("sidebar-collapsed");
      setCollapsed(!isCollapsed);
    });

    function openMobileSidebar() {
      sidebar.classList.remove("hidden");
      overlay.classList.remove("hidden");
      document.body.classList.add("overflow-hidden");
    }
    function closeMobileSidebar() {
      sidebar.classList.add("hidden");
      overlay.classList.add("hidden");
      document.body.classList.remove("overflow-hidden");
    }

    mobileMenuBtn?.addEventListener("click", () => {
      const isHidden = sidebar.classList.contains("hidden");
      if (isHidden) openMobileSidebar(); else closeMobileSidebar();
    });

    overlay?.addEventListener("click", closeMobileSidebar);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !overlay.classList.contains("hidden")) closeMobileSidebar();
    });

    function syncMobileVisibility() {
      if (window.matchMedia("(min-width: 768px)").matches) {
        sidebar.classList.remove("hidden");
        overlay.classList.add("hidden");
        document.body.classList.remove("overflow-hidden");
      } else {
        sidebar.classList.add("hidden");
      }
    }
    
    syncMobileVisibility();
    window.addEventListener("resize", syncMobileVisibility);
  </script>
</body>
</html>
