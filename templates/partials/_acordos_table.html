{# templates/partials/_acordos_table.html #}

<style>
  .ac-card{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:14px;
    overflow:hidden;
  }
  .ac-card-h{
    padding:14px 16px;
    border-bottom:1px solid #e5e7eb;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .ac-card-title{
    font-weight:800;
    color:#111827;
    display:flex;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .ac-pill{
    display:none;
    font-size:12px;
    padding:2px 10px;
    border-radius:999px;
    background:#111827;
    color:#fff;
    font-weight:700;
  }
  .ac-actions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
  .ac-btn{
    padding:8px 12px;
    border-radius:10px;
    border:1px solid #e5e7eb;
    background:#fff;
    font-weight:700;
    font-size:13px;
    cursor:pointer;
    white-space:nowrap;
  }
  .ac-btn:hover{ background:#f9fafb; }
  .ac-btn-primary{
    background:#4f46e5;
    border-color:#4f46e5;
    color:#fff;
  }
  .ac-btn-primary:hover{ background:#4338ca; }

  /* ====== Barra de totais (responde aos filtros) ====== */
  .ac-totals{
    width:100%;
    display:grid;
    grid-template-columns: repeat(5, minmax(160px, 1fr));
    gap:10px;
    padding:12px 16px;
    border-bottom:1px solid #e5e7eb;
    background:#fafafa;
  }
  .ac-total-box{
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    padding:10px 12px;
    min-width: 160px;
  }
  .ac-total-label{
    font-size:11px;
    font-weight:950;
    letter-spacing:.08em;
    color:#6b7280;
    text-transform:uppercase;
  }
  .ac-total-value{
    margin-top:6px;
    font-size:16px;
    font-weight:950;
    color:#111827;
    white-space:nowrap;
  }
  .ac-total-sub{
    margin-top:4px;
    font-size:12px;
    color:#6b7280;
  }
  .ac-total-box.total{
    border-color:#c7d2fe;
    background:#eef2ff;
  }
  .ac-total-box.total .ac-total-label{ color:#4338ca; }
  .ac-total-box.total .ac-total-value{ color:#111827; }

  @media (max-width: 1200px){
    .ac-totals{ grid-template-columns: repeat(3, minmax(160px, 1fr)); }
  }
  @media (max-width: 740px){
    .ac-totals{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
  }
  @media (max-width: 480px){
    .ac-totals{ grid-template-columns: 1fr; }
  }

  /* WRAP com altura fixa (~50 linhas) */
  .ac-table-wrap{
    overflow:auto;
    min-height: 1100px;
    max-height: 1100px;
    position:relative;
  }

  table.ac-table{ width:100%; border-collapse:separate; border-spacing:0; }
  table.ac-table thead th{
    position:sticky;
    top:0;
    z-index:3;
    background:#f9fafb;
    border-bottom:1px solid #e5e7eb;
    font-size:12px;
    font-weight:800;
    text-transform:uppercase;
    color:#374151;
    padding:10px 14px;
    white-space:nowrap;
  }
  table.ac-table tbody td{
    padding:10px 14px;
    border-bottom:1px solid #f1f5f9;
    font-size:13px;
    vertical-align:top;
    color:#111827;
  }

  /* hover só se NÃO tiver cor aplicada */
  table.ac-table tbody tr:not(.ac-colored):hover{ background:#fafafa; cursor:default; }
  table.ac-table tbody tr.ac-colored:hover{ filter: brightness(0.98); }

  .ac-th-inner{
    display:inline-flex;
    align-items:center;
    gap:8px;
    white-space:nowrap;
  }
  .ac-th-tools{
    display:inline-flex;
    align-items:center;
    gap:6px;
    flex:0 0 auto;
  }
  .ac-dot{
    width:8px; height:8px;
    border-radius:999px;
    background:#111827;
    display:none;
    flex:0 0 auto;
  }
  th.ac-filtered .ac-dot{ display:inline-block; }
  .ac-th-btn{
    font-size:12px;
    line-height:1;
    padding:2px 6px;
    border-radius:8px;
    cursor:pointer;
    user-select:none;
  }
  .ac-th-btn:hover{ background:#e5e7eb; }

  /* ===== Filter panel ===== */
  .ac-panel{
    position:fixed;
    background:#fff;
    border:1px solid #e5e7eb;
    border-radius:12px;
    width:380px;
    box-shadow:0 18px 60px rgba(0,0,0,.18);
    z-index:2147483647;
    display:none;
    padding:10px;
  }
  .ac-panel *{ box-sizing:border-box; }
  .ac-panel-top{ display:flex; gap:10px; align-items:center; }
  .ac-panel input[type="search"]{
    width:100%;
    padding:8px 10px;
    border:1px solid #e5e7eb;
    border-radius:10px;
    outline:none;
    font-size:13px;
  }
  .ac-mode{
    display:none;
    padding:4px;
    border:1px solid #e5e7eb;
    border-radius:999px;
    background:#fff;
    flex:0 0 auto;
  }
  .ac-mode button{
    padding:7px 12px;
    border-radius:999px;
    border:1px solid transparent;
    font-weight:900;
    font-size:12px;
    color:#6b7280;
    background:transparent;
    cursor:pointer;
    white-space:nowrap;
    line-height:1;
  }
  .ac-mode button.active{ background:#111827; color:#fff; }
  .ac-panel-list{
    margin-top:10px;
    border:1px solid #e5e7eb;
    border-radius:10px;
    padding:8px;
    overflow:auto;
    min-height:520px;
    max-height:520px;
  }
  .ac-panel-item{
    display:flex;
    align-items:center;
    gap:8px;
    padding:6px 6px;
    border-radius:8px;
    font-size:13px;
    cursor:pointer;
    user-select:none;
  }
  .ac-panel-item:hover{ background:#f9fafb; }
  .ac-panel-item input{ cursor:pointer; }
  .ac-panel-actions{
    margin-top:10px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap:8px;
  }
  .ac-panel-actions button{
    padding:7px 8px;
    border-radius:10px;
    border:1px solid #e5e7eb;
    background:#fff;
    font-weight:900;
    font-size:12px;
    cursor:pointer;
  }
  .ac-panel-actions button:hover{ background:#f9fafb; }
  .ac-panel-actions .primary{
    background:#4f46e5;
    border-color:#4f46e5;
    color:#fff;
  }
  .ac-panel-actions .primary:hover{ background:#4338ca; }
  .ac-panel-actions .sort{
    border-color:#c7d2fe;
    color:#4338ca;
  }
  .ac-panel-actions .sort:hover{ background:#eef2ff; }

  .clamp-2{ display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; }

  /* ===================== MODAL (SCROLL OK) ===================== */
  .ac-modal-overlay{
    position:fixed; inset:0;
    background: rgba(17,24,39,.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 2147483646;
    padding: 16px;
  }
  .ac-modal{
    width:min(1100px, 100%);
    max-height: calc(100vh - 32px);
    background:#fff;
    border-radius:18px;
    border:1px solid #e5e7eb;
    box-shadow:0 30px 90px rgba(0,0,0,.35);
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .ac-modal-h{
    flex: 0 0 auto;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:14px 16px;
    border-bottom:1px solid #e5e7eb;
    background:#f9fafb;
  }
  .ac-modal-h .left{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
  }
  .ac-modal-badge{
    font-size:12px;
    font-weight:900;
    color:#4338ca;
    background:#eef2ff;
    border:1px solid #c7d2fe;
    padding:4px 10px;
    border-radius:999px;
    white-space:nowrap;
  }
  .ac-modal-title{
    font-weight:950;
    color:#111827;
    font-size:15px;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .ac-modal-sub{
    font-size:12px;
    color:#6b7280;
    margin-top:2px;
  }
  .ac-modal-close{
    width:40px;height:40px;
    border-radius:12px;
    border:1px solid #e5e7eb;
    background:#fff;
    cursor:pointer;
    font-weight:900;
  }
  .ac-modal-close:hover{ background:#f3f4f6; }
  .ac-modal-b{
    flex: 1 1 auto;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    padding:16px;
    background:#fff;
  }
  .ac-grid{
    display:grid;
    grid-template-columns: repeat(12, 1fr);
    gap:12px;
  }
  .ac-field{ grid-column: span 6; }
  .ac-field.col-12{ grid-column: span 12; }
  .ac-field.col-4{ grid-column: span 4; }
  .ac-field.col-3{ grid-column: span 3; }
  .ac-field.col-8{ grid-column: span 8; }
  .ac-field label{
    display:block;
    font-size:11px;
    font-weight:950;
    color:#374151;
    margin-bottom:6px;
    text-transform:uppercase;
    letter-spacing:.08em;
  }
  .ac-input, .ac-select, .ac-textarea{
    width:100%;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #e5e7eb;
    outline:none;
    font-size:14px;
    background:#fff;
  }
  .ac-input:focus, .ac-select:focus, .ac-textarea:focus{
    border-color:#c7d2fe;
    box-shadow:0 0 0 4px rgba(79,70,229,.12);
  }
  .ac-textarea{ min-height: 110px; resize: vertical; }
  .ac-modal-f{
    flex: 0 0 auto;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    padding:14px 16px;
    border-top:1px solid #e5e7eb;
    background:#fff;
  }
  .ac-error{
    display:none;
    color:#b91c1c;
    font-weight:800;
    font-size:13px;
  }
  .ac-f-actions{ display:flex; gap:10px; align-items:center; }
  .ac-mbtn{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid #e5e7eb;
    background:#fff;
    font-weight:900;
    cursor:pointer;
  }
  .ac-mbtn:hover{ background:#f9fafb; }
  .ac-mbtn.primary{
    background:#4f46e5;
    border-color:#4f46e5;
    color:#fff;
  }
  .ac-mbtn.primary:hover{ background:#4338ca; }
  body.ac-modal-open{ overflow:hidden; }

  @media (max-width: 900px){
    .ac-field, .ac-field.col-4, .ac-field.col-3, .ac-field.col-8{ grid-column: span 12; }
  }

  /* ===================== SCROLLBAR HORIZONTAL FIXA NO RODAPÉ ===================== */
  .ac-xscroll-fixed{
    position:fixed;
    bottom:0;
    height:14px;
    overflow-x:auto;
    overflow-y:hidden;
    z-index:2147483645;
    background: rgba(255,255,255,0.85);
    border-top:1px solid #e5e7eb;
    backdrop-filter: blur(6px);
    display:none;
  }
  .ac-xscroll-fixed .ac-xscroll-inner{ height:1px; }
  body{ padding-bottom: 18px; }

  /* ===================== REGRAS DE COR (CLASSES) ===================== */
  .ac-row-cnpj{ background:#ff00ff !important; }
  .ac-row-arepassar{ background:#ffff00 !important; }
  .ac-row-repassado{ background:#c27ba0 !important; }
  .ac-row-iddeposito{ background:#00b050 !important; }
  .ac-row-aguardando-pix{ background:#0070c0 !important; }
  .ac-row-aguardando-retorno{ background:#a2c4c9 !important; }

  .ac-row-aguardando-pix td{ color:#ffffff !important; }

  .ac-colored .ac-btn{
    background: rgba(255,255,255,0.88);
    border-color: rgba(17,24,39,0.15);
  }
  .ac-colored .ac-btn:hover{ background: rgba(255,255,255,0.96); }
</style>

<div class="ac-card">
  <div class="ac-card-h">
    <div class="ac-card-title">
      Registros (<span id="acRowsCount">{{ rows|length }}</span>)
      <span id="acFilteredBadge" class="ac-pill">Filtrado</span>
    </div>

    <div class="ac-actions">
      <button type="button" class="ac-btn" onclick="AC.clearAll()">Limpar todos os filtros</button>
      <button type="button" class="ac-btn ac-btn-primary" onclick="openCreateModal()">Novo acordo</button>
    </div>
  </div>

  <!-- ===== Totais dinâmicos (CORREÇÃO, HONORÁRIOS, AUDIENCISTA, SUCUMBÊNCIA + TOTAL) ===== -->
  <div class="ac-totals" id="acTotalsBar" aria-live="polite">
    <div class="ac-total-box">
      <div class="ac-total-label">Correção</div>
      <div class="ac-total-value" id="acSumCorrecao">R$ 0,00</div>
      <div class="ac-total-sub">Somatório dos visíveis</div>
    </div>

    <div class="ac-total-box">
      <div class="ac-total-label">Honorários</div>
      <div class="ac-total-value" id="acSumHonorarios">R$ 0,00</div>
      <div class="ac-total-sub">Somatório dos visíveis</div>
    </div>

    <div class="ac-total-box">
      <div class="ac-total-label">Audiencista</div>
      <div class="ac-total-value" id="acSumAudiencista">R$ 0,00</div>
      <div class="ac-total-sub">Somatório dos visíveis</div>
    </div>

    <div class="ac-total-box">
      <div class="ac-total-label">Sucumbência</div>
      <div class="ac-total-value" id="acSumSucumbencia">R$ 0,00</div>
      <div class="ac-total-sub">Somatório dos visíveis</div>
    </div>

    <div class="ac-total-box total">
      <div class="ac-total-label">Total geral</div>
      <div class="ac-total-value" id="acSumTotalGeral">R$ 0,00</div>
      <div class="ac-total-sub">Soma dos 4 campos</div>
    </div>
  </div>

  <div class="ac-table-wrap">
    <table class="ac-table" id="acTable">
      <thead>
        <tr>
          <th>DATA ACORDO</th>
          <th>NÚMERO PROCESSO</th>
          <th>UF</th>
          <th>RÉU</th>
          <th>AUTOR</th>
          <th>TEL.</th>
          <th>ESCRITÓRIO DO RÉU</th>
          <th>VALOR ACORDO</th>
          <th>STATUS</th>

          <th>PRAZO ESTIMADO</th>
          <th>PRAZO REAL</th>
          <th>DATA PAGAMENTO</th>
          <th>LOCAL</th>
          <th>TIPO</th>
          <th>HONORÁRIOS</th>
          <th>AUDIENCISTA</th>
          <th>REPASSE</th>
          <th>CHAVE PIX</th>
          <th>SUCUMBÊNCIA</th>
          <th style="min-width:320px;">OBSERVAÇÕES</th>

          <th style="text-align:right;" class="no-filter">Ações</th>
        </tr>
      </thead>

      <tbody id="acTbody">
        {% for r in rows %}
        <tr data-row='{{ r|tojson|safe }}' data-id="{{ r.id }}" class="ac-row">
          <td class="whitespace-nowrap"><div class="clamp-2 ac-date">{{ r.data_acordo or "-" }}</div></td>
          <td class="font-medium whitespace-nowrap"><div class="clamp-2">{{ r.numero_processo or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.uf or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.reu or "-" }}</div></td>
          <td style="min-width:220px; max-width:340px;"><div class="clamp-2">{{ r.autor or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.tel or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.escritorio_reu or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.valor_acordo or "-" }}</div></td>
          <td style="min-width:260px; max-width:360px;"><div class="clamp-2">{{ r.status or "-" }}</div></td>

          <td><div class="clamp-2">{{ r.prazo_estimado or "-" }}</div></td>
          <td class="whitespace-nowrap"><div class="clamp-2 ac-date">{{ r.prazo_real or "-" }}</div></td>
          <td class="whitespace-nowrap"><div class="clamp-2 ac-date">{{ r.data_pagamento or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.local or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.tipo or "-" }}</div></td>

          <td><div class="clamp-2">{{ r.honorarios or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.audiencista or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.repasse or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.chave_pix or "-" }}</div></td>
          <td><div class="clamp-2">{{ r.sucumbencia or "-" }}</div></td>
          <td style="min-width:320px; max-width:520px;"><div class="clamp-2">{{ r.observacoes or "-" }}</div></td>

          <td style="text-align:right; white-space:nowrap;">
            <button class="ac-btn ac-edit-btn" type="button"
              onclick="openEditModalFromRow(this.closest('tr'))">Editar</button>

            <button class="ac-btn" type="button"
              style="margin-left:8px;border-color:#fecaca;color:#dc2626;"
              onclick="AC.deleteFromBtn(event, {{ r.id }})">Excluir</button>
          </td>
        </tr>
        {% endfor %}

        {% if rows|length == 0 %}
        <tr><td colspan="21" style="padding:18px; color:#6b7280;">Nenhum registro encontrado.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- SCROLL HORIZONTAL FIXO NO RODAPÉ -->
<div id="acXScrollFixed" class="ac-xscroll-fixed" aria-hidden="true">
  <div id="acXScrollInner" class="ac-xscroll-inner"></div>
</div>

<!-- ===================== MODAL (CRIAR/EDITAR) ===================== -->
<div id="acModalOverlay" class="ac-modal-overlay" aria-hidden="true">
  <div class="ac-modal" role="dialog" aria-modal="true" aria-labelledby="acModalTitle">
    <div class="ac-modal-h">
      <div class="left">
        <div id="acModalBadge" class="ac-modal-badge">Editar</div>
        <div style="min-width:0;">
          <div class="ac-modal-title" id="acModalTitle">Acordo</div>
          <div class="ac-modal-sub" id="acModalSub">Preencha os campos e salve.</div>
        </div>
      </div>
      <button class="ac-modal-close" type="button" onclick="closeModal()">✕</button>
    </div>

    <div class="ac-modal-b">
      <input type="hidden" id="acFormMode" value="edit">
      <input type="hidden" id="acId" value="">

      <div class="ac-grid">
        <div class="ac-field col-3">
          <label>Data acordo (dd/mm/aaaa)</label>
          <input class="ac-input" id="acDataAcordo" placeholder="dd/mm/aaaa">
        </div>

        <div class="ac-field col-3">
          <label>UF</label>
          <select class="ac-select" id="acUfSelect">
            <option value="">Selecione...</option>
          </select>
        </div>

        <div class="ac-field col-6">
          <label>Número processo</label>
          <input class="ac-input" id="acNumeroProcesso" placeholder="Número do processo">
        </div>

        <div class="ac-field col-6">
          <label>Réu</label>
          <select class="ac-select" id="acReuSelect">
            <option value="">Selecione...</option>
          </select>
        </div>

        <div class="ac-field col-6">
          <label>Autor</label>
          <input class="ac-input" id="acAutor" placeholder="Autor">
        </div>

        <div class="ac-field col-4">
          <label>Telefone</label>
          <input class="ac-input" id="acTel" placeholder="Telefone">
        </div>

        <div class="ac-field col-8">
          <label>Escritório do réu</label>
          <select class="ac-select" id="acEscritorioReuSelect">
            <option value="">Selecione...</option>
          </select>
        </div>

        <div class="ac-field col-4">
          <label>Valor acordo</label>
          <input class="ac-input" id="acValorAcordo" placeholder="Ex: 1500.00">
        </div>

        <div class="ac-field col-8">
          <label>Status</label>
          <select class="ac-select" id="acStatusSelect">
            <option value="">Selecione...</option>
          </select>
        </div>

        <div class="ac-field col-4">
          <label>Prazo estimado</label>
          <select class="ac-select" id="acPrazoEstimadoSelect">
            <option value="">Selecione...</option>
          </select>
        </div>

        <div class="ac-field col-4">
          <label>Prazo real (dd/mm/aaaa)</label>
          <input class="ac-input" id="acPrazoReal" placeholder="dd/mm/aaaa">
        </div>

        <div class="ac-field col-4">
          <label>Data pagamento (dd/mm/aaaa)</label>
          <input class="ac-input" id="acDataPagamento" placeholder="dd/mm/aaaa">
        </div>

        <div class="ac-field col-6">
          <label>Local</label>
          <select class="ac-select" id="acLocalSelect">
            <option value="">Selecione...</option>
          </select>
        </div>

        <div class="ac-field col-6">
          <label>Tipo</label>
          <input class="ac-input" id="acTipo" placeholder="Tipo">
        </div>

        <div class="ac-field col-4">
          <label>Honorários</label>
          <input class="ac-input" id="acHonorarios" placeholder="Ex: 500.00">
        </div>

        <div class="ac-field col-4">
          <label>Audiencista</label>
          <input class="ac-input" id="acAudiencista" placeholder="Audiencista">
        </div>

        <div class="ac-field col-4">
          <label>Repasse</label>
          <input class="ac-input" id="acRepasse" placeholder="Ex: 250.00">
        </div>

        <div class="ac-field col-6">
          <label>Chave PIX</label>
          <input class="ac-input" id="acChavePix" placeholder="Chave PIX">
        </div>

        <div class="ac-field col-6">
          <label>Sucumbência</label>
          <input class="ac-input" id="acSucumbencia" placeholder="Sucumbência">
        </div>

        <div class="ac-field col-12">
          <label>Observações</label>
          <textarea class="ac-textarea" id="acObservacoes" placeholder="Escreva aqui..."></textarea>
        </div>
      </div>
    </div>

    <div class="ac-modal-f">
      <div id="acError" class="ac-error"></div>
      <div class="ac-f-actions">
        <button class="ac-mbtn" type="button" onclick="closeModal()">Cancelar</button>
        <button class="ac-mbtn primary" id="acSaveBtn" type="button" onclick="submitModal()">Salvar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== DELETE (FUNCIONA) ===================== */
async function deleteAcordo(id){
  if(!id) return;
  if(!confirm("Tem certeza que deseja excluir este acordo?")) return;

  try{
    const resp = await fetch(`/acordos/${id}`, { method: "DELETE" });
    if(!resp.ok){
      const txt = await resp.text();
      alert(txt || "Falha ao excluir.");
      return;
    }
    window.location.reload();
  }catch(e){
    console.error(e);
    alert("Falha de rede ao excluir.");
  }
}
</script>

<script>
/* ===================== APLICA REGRAS DE COR (HIERARQUIA) ===================== */
(function(){
  const tbody = document.getElementById("acTbody");
  const table = document.getElementById("acTable");
  if(!tbody || !table) return;

  function norm(s){
    return String(s ?? "")
      .trim()
      .toUpperCase()
      .replace(/\s+/g, " ");
  }

  function clearColorClasses(tr){
    tr.classList.remove(
      "ac-colored",
      "ac-row-cnpj",
      "ac-row-arepassar",
      "ac-row-repassado",
      "ac-row-iddeposito",
      "ac-row-aguardando-pix",
      "ac-row-aguardando-retorno"
    );
  }

  function applyRule(tr){
    clearColorClasses(tr);

    let rowObj = {};
    try{
      rowObj = JSON.parse(tr.dataset.row || "{}");
    }catch(_){ rowObj = {}; }

    const tipo   = norm(rowObj.tipo   ?? tr.cells[13]?.innerText);
    const status = norm(rowObj.status ?? tr.cells[8]?.innerText);
    const local  = norm(rowObj.local  ?? tr.cells[12]?.innerText);

    if (tipo === "CNPJ"){
      tr.classList.add("ac-colored", "ac-row-cnpj");
      return;
    }
    if (status === "A REPASSAR"){
      tr.classList.add("ac-colored", "ac-row-arepassar");
      return;
    }
    if (status === "REPASSADO"){
      tr.classList.add("ac-colored", "ac-row-repassado");
      return;
    }
    if (local === "ID DEPÓSITO" || local === "ID DEPOSITO"){
      tr.classList.add("ac-colored", "ac-row-iddeposito");
      return;
    }
    if (status === "AGUARDANDO AUTORIZAÇÃO PIX (BRADESCO)" || status === "AGUARDANDO AUTORIZACAO PIX (BRADESCO)"){
      tr.classList.add("ac-colored", "ac-row-aguardando-pix");
      return;
    }
    if (status === "AGUARDANDO RETORNO DO CLIENTE"){
      tr.classList.add("ac-colored", "ac-row-aguardando-retorno");
      return;
    }
  }

  function applyAll(){
    tbody.querySelectorAll("tr.ac-row").forEach(tr => applyRule(tr));
  }

  applyAll();
  window.AC_COLORS = { refresh: applyAll };
})();
</script>

<script>
/* ===================== TABELA + FILTROS + DATAS BR + TOTAIS (COR/HON/AUD/SUC) ===================== */
(function(){
  const table = document.getElementById('acTable');
  const thead = table?.tHead?.rows?.[0];
  const tbody = document.getElementById('acTbody');
  const badge = document.getElementById('acFilteredBadge');
  const countEl = document.getElementById('acRowsCount');

  const sumEls = {
    correcao: document.getElementById("acSumCorrecao"),
    honorarios: document.getElementById("acSumHonorarios"),
    audiencista: document.getElementById("acSumAudiencista"),
    sucumbencia: document.getElementById("acSumSucumbencia"),
    total: document.getElementById("acSumTotalGeral"),
  };

  if (!thead || !tbody) return;

  function toBRDateText(raw){
    if(!raw) return '-';
    raw = String(raw).trim();
    if(raw === '-' || raw === '') return '-';
    if(/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return raw;

    const m1 = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(m1){
      const yyyy = m1[1], mm = m1[2], dd = m1[3];
      return `${dd}/${mm}/${yyyy}`;
    }
    return raw;
  }

  function toDayKey(raw){
    const br = toBRDateText(raw);
    return br === '-' ? '-' : br;
  }
  function toMonthKey(raw){
    const br = toBRDateText(raw);
    if(br === '-' || !/^\d{2}\/\d{2}\/\d{4}$/.test(br)) return br;
    const [dd, mm, yyyy] = br.split('/');
    return `${mm}/${yyyy}`;
  }

  tbody.querySelectorAll('.ac-date').forEach(el=>{
    el.textContent = toBRDateText(el.textContent);
  });

  // ===== painel =====
  let panel = document.getElementById('acGlobalFilterPanel');
  if (!panel) {
    panel = document.createElement('div');
    panel.id = 'acGlobalFilterPanel';
    panel.className = 'ac-panel';
    panel.innerHTML = `
      <div class="ac-panel-top">
        <input type="search" placeholder="Pesquisar...">
        <div class="ac-mode" id="acDateMode" role="group" aria-label="Modo de data">
          <button type="button" data-mode="day" class="active">Dia</button>
          <button type="button" data-mode="month">Mês</button>
        </div>
      </div>
      <div class="ac-panel-list"></div>
      <div class="ac-panel-actions">
        <button type="button" class="sort" data-sort="asc">A→Z</button>
        <button type="button" class="sort" data-sort="desc">Z→A</button>
        <button type="button" data-act="clear">Limpar</button>
        <button type="button" class="primary" data-act="ok" style="grid-column: span 2;">OK</button>
      </div>
    `;
    document.body.appendChild(panel);
  }

  panel.addEventListener('wheel', (e)=> e.stopPropagation(), { passive:true });
  panel.addEventListener('mousedown', (e)=> e.stopPropagation());
  panel.addEventListener('touchstart', (e)=> e.stopPropagation(), { passive:true });

  const allRows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.querySelector('.ac-edit-btn'));

  const FILTERABLE_COLS = [];
  Array.from(thead.cells).forEach((th, idx) => {
    const title = (th.innerText || '').trim().toLowerCase();
    if (title === 'ações' || th.classList.contains('no-filter')) return;
    FILTERABLE_COLS.push(idx);
  });

  let filters = {};
  let sort = null;
  let openCol = null;

  function textOfCell(row, col){
    const cell = row.cells[col];
    if (!cell) return '-';
    const t = (cell.innerText || '').trim();
    return t === '' ? '-' : t;
  }

  function isDateCol(col){
    const headerText = (thead.cells[col]?.innerText || '').toLowerCase();
    return headerText.includes('data') || headerText.includes('prazo real');
  }

  function cellValueForFilter(row, col, fObj){
    const raw = textOfCell(row, col);
    if (fObj?.type === 'date'){
      return fObj.mode === 'month' ? toMonthKey(raw) : toDayKey(raw);
    }
    return raw;
  }

  function matchesFilters(row, f = filters){
    for (const [colStr, fObj] of Object.entries(f)){
      const col = Number(colStr);
      const v = cellValueForFilter(row, col, fObj);
      if (!fObj?.set || !fObj.set.has(v)) return false;
    }
    return true;
  }

  function getVisibleRows(){
    return allRows.filter(r => matchesFilters(r));
  }

  // ======= parse num BR + render moeda =======
  function numFromAny(v){
    if (v === null || v === undefined) return 0;
    if (typeof v === "number" && Number.isFinite(v)) return v;

    const s0 = String(v).trim();
    if (!s0 || s0 === "-") return 0;

    let s = s0.replace(/\s/g, "").replace(/R\$/gi, "");
    s = s.replace(/[^0-9.,-]/g, "");
    if (!s || s === "-" || s === "," || s === ".") return 0;

    if (s.includes(",") && s.includes(".")){
      if (s.lastIndexOf(",") > s.lastIndexOf(".")){
        s = s.replace(/\./g, "").replace(",", ".");
      } else {
        s = s.replace(/,/g, "");
      }
    } else if (s.includes(",") && !s.includes(".")){
      s = s.replace(/\./g, "").replace(",", ".");
    }

    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  const moneyFmt = new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
    maximumFractionDigits: 2
  });
  function money(n){ return moneyFmt.format(Number(n || 0)); }

  // índices das colunas numéricas no THEAD atual
  const COL_IDX = {
    correcao: 13,     // LOCAL
    honorarios: 14,   // HONORÁRIOS
    audiencista: 15,  // AUDIENCISTA
    sucumbencia: 18   // SUCUMBÊNCIA
  };

  // ATENÇÃO:
  // Na tabela de ACORDOS, não existe coluna "CORREÇÃO" no THEAD.
  // Então a somatória de "CORREÇÃO" precisa vir do objeto (dataset.row) se o campo existir,
  // ou ficará 0 caso não exista.
  // Se você tiver uma coluna "correcao" no backend (r.correcao), já funciona via dataset.row.
  function readRowObj(tr){
    try{ return JSON.parse(tr.dataset.row || "{}"); }
    catch(_){ return {}; }
  }

  function computeTotalsFromVisibleRows(visibleRows){
    let sCor = 0, sHon = 0, sAud = 0, sSuc = 0;

    for (const tr of visibleRows){
      const obj = readRowObj(tr);

      // CORREÇÃO: tenta pegar do objeto; se não existir, tenta célula (mas hoje o índice 13 é LOCAL)
      const vCor = (obj.correcao ?? obj.correção ?? obj["correção"] ?? obj["correcao"] ?? null);
      if (vCor !== null && vCor !== undefined) sCor += numFromAny(vCor);

      const vHon = (obj.honorarios ?? textOfCell(tr, COL_IDX.honorarios));
      const vAud = (obj.audiencista ?? textOfCell(tr, COL_IDX.audiencista));
      const vSuc = (obj.sucumbencia ?? textOfCell(tr, COL_IDX.sucumbencia));

      sHon += numFromAny(vHon);
      sAud += numFromAny(vAud);
      sSuc += numFromAny(vSuc);
    }

    const total = sCor + sHon + sAud + sSuc;
    return { sCor, sHon, sAud, sSuc, total };
  }

  function renderTotals(){
    const vis = getVisibleRows();
    const t = computeTotalsFromVisibleRows(vis);

    if (sumEls.correcao) sumEls.correcao.textContent = money(t.sCor);
    if (sumEls.honorarios) sumEls.honorarios.textContent = money(t.sHon);
    if (sumEls.audiencista) sumEls.audiencista.textContent = money(t.sAud);
    if (sumEls.sucumbencia) sumEls.sucumbencia.textContent = money(t.sSuc);
    if (sumEls.total) sumEls.total.textContent = money(t.total);
  }

  function apply(){
    allRows.forEach(r => r.style.display = matchesFilters(r) ? '' : 'none');

    if (sort){
      const vis = getVisibleRows();
      const col = sort.col;
      const dir = sort.dir;

      vis.sort((a,b)=>{
        const A = textOfCell(a,col);
        const B = textOfCell(b,col);

        if (isDateCol(col)){
          const aBr = toBRDateText(A);
          const bBr = toBRDateText(B);
          const aIso = (aBr === '-' ? '' : aBr.split('/').reverse().join('-'));
          const bIso = (bBr === '-' ? '' : bBr.split('/').reverse().join('-'));
          const cmp = aIso.localeCompare(bIso);
          return dir === 'asc' ? cmp : -cmp;
        }

        const aNum = parseFloat(A.replace(/[^\d.-]/g,''));
        const bNum = parseFloat(B.replace(/[^\d.-]/g,''));
        let cmp = 0;

        if (!isNaN(aNum) && !isNaN(bNum) && (A.match(/\d/) && B.match(/\d/))){
          cmp = aNum - bNum;
        } else {
          cmp = A.localeCompare(B, 'pt-BR');
        }
        return dir === 'asc' ? cmp : -cmp;
      });

      vis.forEach(r => tbody.appendChild(r));
    }

    const visCount = getVisibleRows().length;
    if (countEl) countEl.textContent = visCount;

    const hasFilters = Object.keys(filters).length > 0;
    if (badge) badge.style.display = hasFilters ? 'inline-block' : 'none';

    FILTERABLE_COLS.forEach(i=>{
      const th = thead.cells[i];
      if (!th) return;
      th.classList.toggle('ac-filtered', !!filters[i]);
    });

    window.AC_XSCROLL?.refresh?.();
    window.AC_COLORS?.refresh?.();

    renderTotals();
  }

  function valuesForColumn(col, forcedDateMode = null){
    const temp = {...filters};
    delete temp[col];

    const candidates = allRows.filter(r => matchesFilters(r, temp));
    const vals = new Set();
    const existing = filters[col] || null;

    if (isDateCol(col)){
      const mode = forcedDateMode || (existing?.type === 'date' ? existing.mode : 'day');
      candidates.forEach(r=>{
        const raw = textOfCell(r,col);
        vals.add(mode === 'month' ? toMonthKey(raw) : toDayKey(raw));
      });

      return Array.from(vals).sort((a,b)=>{
        if(mode === 'month'){
          const [am, ay] = a.split('/');
          const [bm, by] = b.split('/');
          return `${ay}-${am}`.localeCompare(`${by}-${bm}`,'pt-BR');
        }
        const aKey = a === '-' ? '' : a.split('/').reverse().join('-');
        const bKey = b === '-' ? '' : b.split('/').reverse().join('-');
        return aKey.localeCompare(bKey,'pt-BR');
      });
    }

    candidates.forEach(r => vals.add(textOfCell(r,col)));
    return Array.from(vals).sort((a,b)=>a.localeCompare(b,'pt-BR'));
  }

  function closePanel(){
    panel.style.display = 'none';
    openCol = null;
  }

  function positionPanelNear(th){
    const rect = th.getBoundingClientRect();
    const panelW = 380;
    const margin = 8;

    let left = rect.right - panelW;
    if (left < margin) left = margin;

    let top = rect.bottom + 8;
    const panelH = 680;
    const maxTop = window.innerHeight - panelH - margin;
    if (top > maxTop) top = Math.max(margin, maxTop);

    panel.style.left = left + 'px';
    panel.style.top = top + 'px';
  }

  function setDateModeUI(show, activeMode){
    const wrap = document.getElementById('acDateMode');
    if (!wrap) return;
    wrap.style.display = show ? 'inline-flex' : 'none';
    wrap.querySelectorAll('button').forEach(b=>{
      b.classList.toggle('active', b.dataset.mode === activeMode);
    });
  }

  function populatePanel(col, forcedDateMode = null){
    const list = panel.querySelector('.ac-panel-list');
    list.innerHTML = '';

    const isDate = isDateCol(col);
    let dateMode = 'day';
    const existing = filters[col];

    if (isDate){
      if (forcedDateMode) dateMode = forcedDateMode;
      else if (existing?.type === 'date') dateMode = existing.mode;
      setDateModeUI(true, dateMode);
    } else {
      setDateModeUI(false, 'day');
    }

    const vals = valuesForColumn(col, isDate ? dateMode : null);

    let currentSet = null;
    if (existing?.type === 'date' && isDate) currentSet = existing.set;
    else if (existing?.type === 'set') currentSet = existing.set;

    vals.forEach(v=>{
      const lab = document.createElement('label');
      lab.className = 'ac-panel-item';
      lab.dataset.val = v;
      const checked = currentSet ? currentSet.has(v) : false;

      lab.innerHTML = `
        <input type="checkbox" ${checked ? 'checked' : ''}>
        <span>${v}</span>
      `;
      list.appendChild(lab);
    });

    const s = panel.querySelector('input[type="search"]');
    if (s) s.value = '';

    panel.dataset.isDateCol = isDate ? '1' : '0';
    panel.dataset.dateMode = isDate ? dateMode : '';
  }

  function openPanelFor(col, th){
    openCol = col;
    populatePanel(col);
    positionPanelNear(th);
    panel.style.display = 'block';
    panel.querySelector('input[type="search"]')?.focus();
  }

  function buildHeaderUI(){
    FILTERABLE_COLS.forEach((col)=>{
      const th = thead.cells[col];
      if (!th) return;
      if (th.dataset.acInited === '1') return;
      th.dataset.acInited = '1';

      const label = (th.innerText || '').trim();
      th.innerHTML = `
        <span class="ac-th-inner">
          <span>${label}</span>
          <span class="ac-th-tools">
            <span class="ac-dot"></span>
            <span class="ac-th-btn" data-act="open" title="Filtrar/Ordenar">▾</span>
          </span>
        </span>
      `;

      th.querySelector('[data-act="open"]').addEventListener('click', (e)=>{
        e.stopPropagation();
        const isOpen = (panel.style.display === 'block' && openCol === col);
        if (isOpen) { closePanel(); return; }
        openPanelFor(col, th);
      });
    });
  }

  panel.querySelector('input[type="search"]').addEventListener('input', (e)=>{
    const q = (e.target.value || '').trim().toLowerCase();
    panel.querySelectorAll('.ac-panel-item').forEach(it=>{
      const v = (it.dataset.val || '').toLowerCase();
      it.style.display = v.includes(q) ? '' : 'none';
    });
  });

  const dateModeWrap = document.getElementById('acDateMode');
  if (dateModeWrap){
    dateModeWrap.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if (openCol === null) return;
        if (panel.dataset.isDateCol !== '1') return;
        const mode = btn.dataset.mode;
        setDateModeUI(true, mode);
        populatePanel(openCol, mode);
      });
    });
  }

  panel.querySelectorAll('[data-sort]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if (openCol === null) return;
      sort = { col: openCol, dir: btn.dataset.sort };
      closePanel();
      apply();
    });
  });

  panel.querySelector('[data-act="clear"]').addEventListener('click', ()=>{
    if (openCol === null) return;
    delete filters[openCol];
    closePanel();
    apply();
  });

  panel.querySelector('[data-act="ok"]').addEventListener('click', ()=>{
    if (openCol === null) return;

    const set = new Set();
    panel.querySelectorAll('.ac-panel-item').forEach(it=>{
      const cb = it.querySelector('input[type="checkbox"]');
      if (cb && cb.checked) set.add(it.dataset.val);
    });

    if (!set.size){
      delete filters[openCol];
      closePanel();
      apply();
      return;
    }

    const isDate = panel.dataset.isDateCol === '1';
    const dateMode = panel.dataset.dateMode || 'day';

    filters[openCol] = isDate
      ? { type:'date', mode:dateMode, set }
      : { type:'set', set };

    closePanel();
    apply();
  });

  document.addEventListener('click', (e)=>{
    if (panel.style.display !== 'block') return;
    const inside = e.target.closest && e.target.closest('#acGlobalFilterPanel');
    const onHeaderBtn = e.target.closest && e.target.closest('.ac-th-btn');
    if (inside || onHeaderBtn) return;
    closePanel();
  });

  document.addEventListener('keydown', (e)=>{
    if (e.key === "Escape" && panel.style.display === "block") closePanel();
  });

  window.addEventListener('resize', ()=>{ if(openCol!==null){ closePanel(); } });

  window.AC = window.AC || {};
  window.AC.clearAll = function(){
    filters = {};
    sort = null;
    closePanel();
    apply();
  };
  window.AC.deleteFromBtn = function(ev, id){
    ev.preventDefault();
    ev.stopPropagation();
    deleteAcordo(id);
  };

  buildHeaderUI();
  apply();
})();
</script>

<script>
/* ===================== DOUBLE CLICK NA LINHA PARA EDITAR ===================== */
(function(){
  const tbody = document.getElementById("acTbody");
  if(!tbody) return;

  tbody.addEventListener("dblclick", (e)=>{
    const tr = e.target.closest("tr");
    if(!tr) return;

    if (e.target.closest("button, a, input, select, textarea")) return;
    if(!tr.querySelector(".ac-edit-btn")) return;

    openEditModalFromRow(tr);
  });
})();
</script>

<script>
/* ===================== SCROLLBAR HORIZONTAL FIXA NO RODAPÉ (SINCRONIZADA E RANGE CORRETO) ===================== */
(function(){
  const wrap  = document.querySelector(".ac-table-wrap");
  const fixed = document.getElementById("acXScrollFixed");
  const inner = document.getElementById("acXScrollInner");
  const table = document.getElementById("acTable");

  if(!wrap || !fixed || !inner || !table) return;

  let syncing = false;

  function getMaxScroll(el){
    return Math.max(0, el.scrollWidth - el.clientWidth);
  }

  function positionFixedOverWrap(){
    const r = wrap.getBoundingClientRect();
    fixed.style.left = Math.max(0, r.left) + "px";
    fixed.style.width = Math.max(0, r.width) + "px";
  }

  function updateInnerWidth(){
    const w = Math.max(table.scrollWidth, wrap.scrollWidth);
    inner.style.width = w + "px";
  }

  function toggleIfOverflow(){
    const hasOverflow = table.scrollWidth > wrap.clientWidth + 2;
    fixed.style.display = hasOverflow ? "block" : "none";
  }

  function syncFixedToWrap(){
    const maxW = getMaxScroll(wrap);
    const maxF = getMaxScroll(fixed);
    if (maxW <= 0 || maxF <= 0) return;
    fixed.scrollLeft = (wrap.scrollLeft / maxW) * maxF;
  }

  function syncWrapToFixed(){
    const maxW = getMaxScroll(wrap);
    const maxF = getMaxScroll(fixed);
    if (maxW <= 0 || maxF <= 0) return;
    wrap.scrollLeft = (fixed.scrollLeft / maxF) * maxW;
  }

  function refresh(){
    positionFixedOverWrap();
    updateInnerWidth();
    toggleIfOverflow();
    syncFixedToWrap();
  }

  fixed.addEventListener("scroll", ()=>{
    if(syncing) return;
    syncing = true;
    syncWrapToFixed();
    syncing = false;
  }, { passive:true });

  wrap.addEventListener("scroll", ()=>{
    if(syncing) return;
    syncing = true;
    syncFixedToWrap();
    syncing = false;
  }, { passive:true });

  const ro = new ResizeObserver(()=> refresh());
  ro.observe(wrap);
  ro.observe(table);

  window.addEventListener("resize", ()=> refresh());
  window.addEventListener("scroll", ()=> positionFixedOverWrap(), { passive:true });

  window.AC_XSCROLL = { refresh };

  refresh();
})();
</script>

<script>
/* ===================== MODAL + DROPDOWNS + CRUD ===================== */
(function(){
  function _showError(msg){
    const el = document.getElementById("acError");
    if(!el) return;
    if(!msg){
      el.style.display = "none";
      el.textContent = "";
      return;
    }
    el.style.display = "block";
    el.textContent = msg;
  }

  function toBRDateText(raw){
    if(!raw) return '';
    raw = String(raw).trim();
    if(raw === '-' || raw === '') return '';
    if(/^\d{2}\/\d{2}\/\d{4}$/.test(raw)) return raw;

    const m1 = raw.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(m1){
      const yyyy = m1[1], mm = m1[2], dd = m1[3];
      return `${dd}/${mm}/${yyyy}`;
    }
    return raw;
  }

  const sel = {
    uf: document.getElementById("acUfSelect"),
    status: document.getElementById("acStatusSelect"),
    reu: document.getElementById("acReuSelect"),
    local: document.getElementById("acLocalSelect"),
    prazo_estimado: document.getElementById("acPrazoEstimadoSelect"),
    escritorio_reu: document.getElementById("acEscritorioReuSelect"),
  };

  let _optionsLoaded = false;
  let _options = null;

  async function loadOptionsOnce(){
    if (_optionsLoaded) return _options;
    _optionsLoaded = true;

    try{
      const resp = await fetch("/api/cadastro-options", { headers: { "Accept": "application/json" }});
      if(!resp.ok) throw new Error("Falha ao carregar opções");
      _options = await resp.json();
    }catch(e){
      console.error(e);
      _options = {};
    }

    fillSelect(sel.uf, (_options["fin_uf"] || []));
    fillSelect(sel.status, (_options["fin_status"] || []));
    fillSelect(sel.reu, (_options["fin_reu"] || []));
    fillSelect(sel.local, (_options["fin_local"] || []));
    fillSelect(sel.prazo_estimado, (_options["fin_prazo_estimado"] || []));
    fillSelect(sel.escritorio_reu, (_options["fin_patrono_reu"] || []));

    return _options;
  }

  function fillSelect(selectEl, items){
    if(!selectEl) return;
    const first = selectEl.querySelector('option[value=""]')
      ? selectEl.querySelector('option[value=""]').outerHTML
      : '<option value="">Selecione...</option>';
    selectEl.innerHTML = first;

    (items || []).forEach(v=>{
      const op = document.createElement("option");
      op.value = String(v);
      op.textContent = String(v);
      selectEl.appendChild(op);
    });
  }

  function openModal(mode){
    const overlay = document.getElementById("acModalOverlay");
    const badge = document.getElementById("acModalBadge");
    const title = document.getElementById("acModalTitle");
    const sub = document.getElementById("acModalSub");
    const formMode = document.getElementById("acFormMode");
    const saveBtn = document.getElementById("acSaveBtn");

    _showError("");

    if(mode === "create"){
      badge.textContent = "Novo";
      title.textContent = "Criar acordo";
      sub.textContent = "Preencha os campos e clique em criar.";
      formMode.value = "create";
      document.getElementById("acId").value = "";
      saveBtn.textContent = "Criar";
      _fillForm({});
    } else {
      badge.textContent = "Editar";
      title.textContent = "Editar acordo";
      sub.textContent = "Ajuste os campos e clique em salvar.";
      formMode.value = "edit";
      saveBtn.textContent = "Salvar";
    }

    overlay.style.display = "flex";
    overlay.setAttribute("aria-hidden", "false");
    document.body.classList.add("ac-modal-open");
  }

  function closeModal(){
    const overlay = document.getElementById("acModalOverlay");
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden", "true");
    document.body.classList.remove("ac-modal-open");
    _showError("");
  }

  function setSelectValue(selectEl, value){
    if(!selectEl) return;
    const v = (value ?? "").toString().trim();
    selectEl.value = v;
    if (v && selectEl.value !== v) selectEl.value = "";
  }

  function _fillForm(row){
    document.getElementById("acId").value = row?.id ?? "";

    document.getElementById("acDataAcordo").value = toBRDateText(row?.data_acordo ?? "");
    document.getElementById("acNumeroProcesso").value = row?.numero_processo ?? "";

    setSelectValue(sel.uf, row?.uf ?? "");
    setSelectValue(sel.reu, row?.reu ?? "");
    setSelectValue(sel.escritorio_reu, row?.escritorio_reu ?? "");
    setSelectValue(sel.status, row?.status ?? "");

    document.getElementById("acAutor").value = row?.autor ?? "";
    document.getElementById("acTel").value = row?.tel ?? "";
    document.getElementById("acValorAcordo").value = row?.valor_acordo ?? "";

    setSelectValue(sel.prazo_estimado, row?.prazo_estimado ?? "");
    document.getElementById("acPrazoReal").value = toBRDateText(row?.prazo_real ?? "");
    document.getElementById("acDataPagamento").value = toBRDateText(row?.data_pagamento ?? "");

    setSelectValue(sel.local, row?.local ?? "");
    document.getElementById("acTipo").value = row?.tipo ?? "";

    document.getElementById("acHonorarios").value = row?.honorarios ?? "";
    document.getElementById("acAudiencista").value = row?.audiencista ?? "";
    document.getElementById("acRepasse").value = row?.repasse ?? "";
    document.getElementById("acChavePix").value = row?.chave_pix ?? "";
    document.getElementById("acSucumbencia").value = row?.sucumbencia ?? "";
    document.getElementById("acObservacoes").value = row?.observacoes ?? "";
  }

  function _collectForm(){
    return {
      id: document.getElementById("acId").value || null,

      data_acordo: document.getElementById("acDataAcordo").value.trim(),
      numero_processo: document.getElementById("acNumeroProcesso").value.trim(),

      uf_id: (sel.uf?.value || "").trim(),
      reu: (sel.reu?.value || "").trim(),
      autor: document.getElementById("acAutor").value.trim(),
      tel: document.getElementById("acTel").value.trim(),
      escritorio_reu: (sel.escritorio_reu?.value || "").trim(),

      valor_acordo: document.getElementById("acValorAcordo").value.trim(),
      status_id: (sel.status?.value || "").trim(),

      prazo_estimado: (sel.prazo_estimado?.value || "").trim(),
      prazo_real: document.getElementById("acPrazoReal").value.trim(),
      data_pagamento: document.getElementById("acDataPagamento").value.trim(),

      local: (sel.local?.value || "").trim(),
      tipo: document.getElementById("acTipo").value.trim(),

      honorarios: document.getElementById("acHonorarios").value.trim(),
      audiencista: document.getElementById("acAudiencista").value.trim(),
      repasse: document.getElementById("acRepasse").value.trim(),
      chave_pix: document.getElementById("acChavePix").value.trim(),
      sucumbencia: document.getElementById("acSucumbencia").value.trim(),
      observacoes: document.getElementById("acObservacoes").value.trim(),
    };
  }

  document.addEventListener("click", (e)=>{
    const overlay = document.getElementById("acModalOverlay");
    if(!overlay || overlay.style.display !== "flex") return;
    if(e.target === overlay) closeModal();
  });

  document.addEventListener("keydown", (e)=>{
    if(e.key !== "Escape") return;
    const overlay = document.getElementById("acModalOverlay");
    if(overlay && overlay.style.display === "flex") closeModal();
  });

  window.closeModal = closeModal;

  window.openCreateModal = async function(){
    await loadOptionsOnce();
    openModal("create");
  };

  window.openEditModalFromRow = async function(tr){
    await loadOptionsOnce();
    try{
      const raw = tr?.dataset?.row || "{}";
      const row = JSON.parse(raw);
      openModal("edit");
      _fillForm(row);
    }catch(err){
      console.error("Erro openEditModalFromRow:", err);
      _showError("Não foi possível abrir edição (dados inválidos).");
    }
  };

  window.submitModal = async function(){
    const mode = document.getElementById("acFormMode").value;
    if(mode === "create") return saveCreate();
    return saveEdit();
  };

  async function saveEdit(){
    const payload = _collectForm();
    if(!payload.id){
      _showError("ID do acordo não encontrado.");
      return;
    }

    try{
      const resp = await fetch(`/acordos/${payload.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if(!resp.ok){
        const txt = await resp.text();
        _showError(txt || "Erro ao salvar edição.");
        return;
      }

      window.location.reload();
    }catch(err){
      console.error(err);
      _showError("Falha de rede ao salvar.");
    }
  }

  async function saveCreate(){
    const payload = _collectForm();
    payload.id = null;

    try{
      const resp = await fetch(`/acordos`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if(!resp.ok){
        const txt = await resp.text();
        _showError(txt || "Erro ao criar acordo.");
        return;
      }

      window.location.reload();
    }catch(err){
      console.error(err);
      _showError("Falha de rede ao criar.");
    }
  }
})();
</script>

<script>
/* ===================== DOUBLE CLICK NA LINHA PARA EDITAR (MANTÉM) ===================== */
(function(){
  const tbody = document.getElementById("acTbody");
  if(!tbody) return;

  tbody.addEventListener("dblclick", (e)=>{
    const tr = e.target.closest("tr");
    if(!tr) return;

    if (e.target.closest("button, a, input, select, textarea")) return;
    if(!tr.querySelector(".ac-edit-btn")) return;

    openEditModalFromRow(tr);
  });
})();
</script>
